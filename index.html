<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Focus Timer + Quick Tasks</title>
<style>
:root {
    --bg1:#020304;
    --bg2:#0a0c0d;
    --card:#111315;
    --ink:#e7ecef;
    --muted:#6b7280;
    --line:#1e2327;
    --accent:#00c26f;     /* robinhood green */
    --accent-2:#10b981;
    --danger:#f87171;
    --radius:16px;
    --shadow:0 8px 25px rgba(0,0,0,.45);
  }

  /* Light Theme */
  [data-theme="light"] {
    --bg1:#f8fafc;
    --bg2:#e2e8f0;
    --card:#ffffff;
    --ink:#1e293b;
    --muted:#64748b;
    --line:#e2e8f0;
    --accent:#00c26f;
    --accent-2:#10b981;
    --danger:#ef4444;
    --shadow:0 8px 25px rgba(0,0,0,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%; transition:background-color .3s ease, color .3s ease}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--ink);
    font-family:"Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:grid; place-items:start; padding:28px;
  }
  .app{width:100%; max-width:960px; margin:0 auto; display:grid; gap:22px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .title{font-weight:800; font-size:clamp(22px,3.5vw,30px); letter-spacing:.3px}
  .sub{color:var(--muted); font-size:14px}
  .card{
    background:var(--card); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
    transition:box-shadow .3s ease, border-color .3s ease;
  }
  .card:hover {
    box-shadow:0 12px 35px rgba(0,0,0,.15);
  }
  .timer{display:grid; grid-template-columns:1fr 1fr; gap:18px}
  @media (max-width:880px){ .timer{grid-template-columns:1fr} }
  .ringWrap{display:grid; place-items:center; position:relative; padding:8px}
  .time{position:absolute; font-weight:800; font-size:clamp(36px,9vw,64px)}
  .controls,.presets{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button,.chip{
    appearance:none; background:var(--card); color:var(--ink);
    border:1px solid var(--line); border-radius:12px;
    padding:10px 14px; cursor:pointer; font-weight:600;
    transition:background .15s ease,border-color .15s ease,transform .06s ease;
  }
  button:hover,.chip:hover{background:var(--bg2); border-color:var(--muted)}
  button:active,.chip:active{transform:translateY(1px)}
  button.primary{background:var(--accent); border-color:var(--accent); color:#000; font-weight:700}
  button.primary:hover{filter:brightness(1.1)}
  button.danger{background:var(--danger); border-color:var(--danger); color:#000}
  button.ghost{background:transparent}
  .presets .chip.active{background:var(--accent-2); border-color:var(--accent-2); color:#000}
  input[type="text"],input[type="number"],textarea{
    width:100%; padding:12px 14px; border-radius:12px;
    background:var(--bg2); color:var(--ink); border:1px solid var(--line); outline:none;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  input[type="text"]:focus,input[type="number"]:focus,textarea:focus{
    border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,194,111,.2);
  }
  .grid{display:grid; grid-template-columns:1.4fr 1fr; gap:18px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
  .taskRow{display:grid; grid-template-columns:1fr auto; gap:8px; margin-top:8px}
  .taskItem{
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
    padding:10px 12px; border-radius:12px; background:var(--bg2); border:1px solid var(--line);
    transition:background .2s ease, border-color .2s ease;
  }
  .taskItem.done{opacity:.6; text-decoration:line-through}
  .checkbox{width:18px;height:18px;accent-color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px}
  .tog{display:inline-flex;align-items:center;gap:8px}
  a.link{color:var(--accent);text-decoration:none;border-bottom:1px dashed rgba(0,194,111,.5)}
  footer{color:var(--muted);text-align:center;font-size:12px}

  /* Analytics Styles */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
  }
  .stat-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 500;
  }
  .foot {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 22px;
    border-bottom: 2px solid var(--line);
    padding-bottom: 0;
  }
  .tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--muted);
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s ease;
    margin-bottom: -2px;
  }
  .tab:hover {
    color: var(--ink);
    background: rgba(255, 255, 255, 0.03);
  }
  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .tabContent {
    display: none;
  }
  .tabContent.active {
    display: grid;
    gap: 22px;
  }

  /* Enhanced Mobile Responsiveness */
  @media (max-width: 600px) {
    body {
      padding: 16px;
    }
    .app {
      gap: 16px;
    }
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    header > div:last-child {
      width: 100%;
    }
    #xpDisplay {
      min-width: 100% !important;
      width: 100%;
    }
    .title {
      font-size: 22px;
    }
    .sub {
      font-size: 13px;
    }
    .card {
      padding: 16px;
    }
    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab {
      padding: 10px 16px;
      font-size: 14px;
      white-space: nowrap;
    }
    .ringWrap svg {
      width: 220px;
      height: 220px;
    }
    .time {
      font-size: 42px;
    }
    .controls, .presets {
      gap: 8px;
    }
    button, .chip {
      padding: 8px 12px;
      font-size: 14px;
    }
    #customMins {

    }
  }

  @media (max-width: 400px) {
    .presets {
      flex-direction: column;
      align-items: stretch;
    }
    .chip, button {
      width: 100%;
      text-align: center;
    }
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
  }

  /* Enhanced Visual Feedback & Animations */
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  @keyframes success {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); background: var(--accent); }
    100% { transform: scale(1); }
  }

  /* Apply animations to elements */
  .taskItem {
    animation: slideIn 0.3s ease;
  }

  button.primary:active {
    animation: pulse 0.3s ease;
  }

  .taskItem:hover {
    border-color: var(--accent);
    transform: translateX(4px);
  }

  .chip:active, button:active {
    transform: translateY(2px) scale(0.98);
  }

  /* Tab switching animation */
  .tabContent.active {
    animation: fadeIn 0.4s ease;
  }

  /* Theme toggle pulse */
  #themeToggle:active {
    animation: pulse 0.2s ease;
  }

  /* Add ripple effect class for JavaScript */
  .ripple {
    position: relative;
    overflow: hidden;
  }

  .ripple::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .ripple:active::after {
    width: 200px;
    height: 200px;
  }

  /* Success state for task completion */
  .taskItem.done {
    animation: success 0.5s ease;
  }

  /* Focus states */
  button:focus-visible, .chip:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  input:focus-visible, textarea:focus-visible {
    outline: none;
  }

  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Modal/Dialog Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
    padding: 20px;
  }

  .modal {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideIn 0.3s ease;
    padding: 28px;
  }

  .modal h2 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 700;
    color: var(--accent);
  }

  .modal-section {
    margin-bottom: 20px;
  }

  .modal-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
    color: var(--ink);
  }

  .modal-section .muted {
    display: block;
    margin-top: 4px;
    font-size: 12px;
  }

  .rating-container {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .rating-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--line);
    background: var(--bg2);
    color: var(--ink);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .rating-btn:hover {
    border-color: var(--accent);
    background: var(--card);
  }

  .rating-btn.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: #000;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 28px;
  }

  .modal-actions button {
    flex: 1;
  }

</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">Focus Timer + Quick Tasks</div>
        <div class="sub">A no-login, one-page productivity tool. Your data saves in your browser.</div>
      </div>
      <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <button id="themeToggle" class="ghost" style="padding: 8px 14px;">
          <span id="themeIcon">üåô</span>
        </button>
        <div class="tog">
          <input id="soundToggle" type="checkbox" />
          <label for="soundToggle" class="small">Chime on session end</label>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div id="focusTab" class="tabContent active">

    <section class="card timer">
      <div class="ringWrap">
        <svg width="260" height="260" viewBox="0 0 120 120" style="position: relative;">
          <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.12)" stroke-width="8" fill="none"/>
          <circle id="progress" cx="60" cy="60" r="52" stroke="url(#g)" stroke-width="8" stroke-linecap="round" fill="none"
                  transform="rotate(-90 60 60)" stroke-dasharray="327" stroke-dashoffset="327"/>
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#7c5cff"></stop>
              <stop offset="100%" stop-color="#33d6a6"></stop>
            </linearGradient>
          </defs>
        </svg>
        <div class="time" id="time">25:00</div>
      </div>

      <div>
        <div class="presets" style="margin-bottom:12px;">
          <button class="chip active" data-mins="25">Pomodoro 25</button>
          <button class="chip" data-mins="5">Short Break 5</button>
          <button class="chip" data-mins="15">Long Break 15</button>
          <span class="spacer"></span>
          <label class="muted small">Custom:</label>
          <input id="customMins" type="number" min="1" max="180" value="25" style="width:84px;" />
          <button class="chip" id="applyCustom">Set</button>
        </div>
        <div class="controls" style="margin-bottom:12px;">
          <button id="startBtn" class="primary">Start</button>
          <button id="pauseBtn" class="ghost">Pause</button>
          <button id="resetBtn" class="danger">Reset</button>
        </div>
        <div class="muted small">
          Tip: switch presets anytime‚Äîprogress resets to match the selected length.
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <strong>Quick Tasks</strong>

        <!-- Analytics Summary -->
        <div class="analytics-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Tasks</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statCompleted">0</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statToday">0</div>
            <div class="stat-label">Today</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statRate">0%</div>
            <div class="stat-label">Rate</div>
          </div>
        </div>

        <div class="taskRow">
          <input id="taskInput" type="text" placeholder="Add a task and press Enter‚Ä¶" />
          <button id="addTask">Add</button>
        </div>
        <div id="taskList" style="display:grid; gap:8px; margin-top:12px;"></div>
        <div class="foot">
          <span class="muted small">Tasks save automatically.</span>
          <div>
            <button id="clearDone" class="ghost small">Clear done</button>
            <button id="clearAll" class="ghost small">Clear all</button>
          </div>
        </div>
      </div>

      <div class="card">
        <strong>Session Notes</strong>
        <textarea id="notes" rows="9" placeholder="Jot down what you're focusing on‚Ä¶"></textarea>
        <div class="foot">
          <span class="muted small">Notes auto-save locally.</span>
          <a id="downloadNotes" href="#" class="link small">Download .txt</a>
        </div>
        <div class="muted small warn">No accounts, no tracking, just your browser.</div>
      </div>
    </section>
    </div>

  </div>

  <!-- Reflection Modal (initially hidden) -->
  <div id="reflectionModal" style="display: none;"></div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const store = {
    get(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    },
    set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
  };

  function getUserProgress() {
    return store.get('userProgress', {
      selectedTheme: 'default',
      selectedSound: 'default'
    });
  }

  function saveUserProgress(progress) {
    store.set('userProgress', progress);
  }
























  // ---------- Theme Toggle ----------
  const themeToggle = $('#themeToggle');
  const themeIcon = $('#themeIcon');
  const savedTheme = store.get('theme', 'dark');

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    themeIcon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    store.set('theme', theme);
  }

  setTheme(savedTheme);

  themeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
  });

  // ---------- Visual Feedback Enhancements ----------
  // Add ripple effect to all buttons
  $$('button, .chip').forEach(btn => {
    btn.classList.add('ripple');
  });

  // Show success toast notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: ${type === 'success' ? 'var(--accent)' : 'var(--danger)'};
      color: #000;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: var(--shadow);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'fadeOut 0.3s ease';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Add visual feedback when timer completes
  const originalChime = window.chime;

  // ---------- Timer State ----------
  let totalSecs = 25*60;
  let remaining = totalSecs;
  let tickId = null;
  const ring = $('#progress');
  const timeEl = $('#time');
  const dash = 2 * Math.PI * 52; // circumference ‚âà 327
  ring.setAttribute('stroke-dasharray', dash);

  // ---------- Session Tracking ----------
  let currentSession = null;

  function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
  }

  function getSessionType(mins) {
    if (mins === 5) return 'Short Break';
    if (mins === 15) return 'Long Break';
    return 'Focus Session';
  }

  function startSession() {
    const tasks = store.get('tasks', []);
    const sessionType = getSessionType(totalSecs / 60);

    currentSession = {
      id: generateSessionId(),
      type: sessionType,
      duration: totalSecs / 60,
      startTime: Date.now(),
      endTime: null,
      tasksAtStart: tasks.map(t => ({ id: t.id, text: t.text, done: t.done })),
      tasksCompleted: [],
      notes: $('#notes').value,
      reflection: null
    };
  }

  function completeSession() {
    if (!currentSession) return;

    currentSession.endTime = Date.now();

    // Find tasks completed during this session
    const tasks = store.get('tasks', []);
    const completedDuringSession = tasks.filter(t => {
      const wasIncomplete = currentSession.tasksAtStart.find(ts => ts.id === t.id && !ts.done);
      return wasIncomplete && t.done;
    });

    currentSession.tasksCompleted = completedDuringSession.map(t => ({
      id: t.id,
      text: t.text
    }));

    // Only show reflection modal for focus sessions, not breaks
    if (currentSession.type === 'Focus Session') {
      showReflectionModal(currentSession);
    } else {
      saveSession(currentSession);
      currentSession = null;
    }
  }

  function saveSession(session) {
    const sessions = store.get('sessions', []);
    sessions.unshift(session);
    // Keep only last 50 sessions
    if (sessions.length > 50) {
      sessions.length = 50;
    }
    store.set('sessions', sessions);
    // renderSessionHistory(); // Removed - history tab disabled
  }

  // ---------- Reflection Modal ----------
  function showReflectionModal(session) {
    const modal = $('#reflectionModal');
    let selectedRating = null;

    const tasksCompletedList = session.tasksCompleted.length > 0
      ? session.tasksCompleted.map(t => `<li>${t.text}</li>`).join('')
      : '<li class="muted">No tasks completed during this session</li>';

    modal.innerHTML = `
      <div class="modal-overlay">
        <div class="modal">
          <h2>üéØ Session Complete!</h2>

          <div class="modal-section">
            <p><strong>Duration:</strong> ${session.duration} minutes</p>
            <p><strong>Tasks completed:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
              ${tasksCompletedList}
            </ul>
          </div>

          <div class="modal-section">
            <label>How focused were you?</label>
            <span class="muted">Rate your focus level during this session</span>
            <div class="rating-container">
              <button class="rating-btn" data-rating="1">üòî<br>Low</button>
              <button class="rating-btn" data-rating="2">üòê<br>Medium</button>
              <button class="rating-btn" data-rating="3">üòä<br>Good</button>
              <button class="rating-btn" data-rating="4">üöÄ<br>Excellent</button>
            </div>
          </div>

          <div class="modal-section">
            <label>What did you accomplish?</label>
            <span class="muted">Reflect on what you achieved during this session</span>
            <textarea id="reflectionAccomplishments" rows="3" placeholder="E.g., Completed the API integration, fixed 3 bugs..."></textarea>
          </div>

          <div class="modal-section">
            <label>Any blockers or insights?</label>
            <span class="muted">Optional: Note any challenges or learnings</span>
            <textarea id="reflectionBlockers" rows="3" placeholder="E.g., Struggled with authentication flow, need to research more..."></textarea>
          </div>

          <div class="modal-actions">
            <button class="ghost" id="skipReflection">Skip</button>
            <button class="primary" id="saveReflection">Save Reflection</button>
          </div>
        </div>
      </div>
    `;

    modal.style.display = 'block';

    // Rating button handlers
    $$('.rating-btn', modal).forEach(btn => {
      btn.addEventListener('click', () => {
        $$('.rating-btn', modal).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedRating = parseInt(btn.dataset.rating);
      });
    });

    // Skip button
    $('#skipReflection', modal).addEventListener('click', () => {
      modal.style.display = 'none';
      saveSession(session);
      currentSession = null;
    });

    // Save button
    $('#saveReflection', modal).addEventListener('click', () => {
      const accomplishments = $('#reflectionAccomplishments', modal).value.trim();
      const blockers = $('#reflectionBlockers', modal).value.trim();

      session.reflection = {
        rating: selectedRating,
        accomplishments: accomplishments,
        blockers: blockers,
        timestamp: Date.now()
      };

      modal.style.display = 'none';
      saveSession(session);
      currentSession = null;
      showToast('üí≠ Reflection saved!', 'success');
    });

    // Close on overlay click
    $('.modal-overlay', modal).addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        modal.style.display = 'none';
        saveSession(session);
        currentSession = null;
      }
    });
  }

  // ---------- Session History Display ----------
  // Removed - history tab disabled
  /* function renderSessionHistory() {
    const sessions = store.get('sessions', []);
    const container = $('#sessionHistory');

    if (sessions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚è±Ô∏è</div>
          <p>No sessions yet</p>
          <p class="small muted">Complete a focus session to see it here</p>
        </div>
      `;
      return;
    }

    container.innerHTML = sessions.map(session => {
      const startDate = new Date(session.startTime);
      const endDate = session.endTime ? new Date(session.endTime) : null;
      const dateStr = startDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      const timeStr = startDate.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit'
      });

      const tasksHtml = session.tasksCompleted.length > 0
        ? `
          <div class="session-tasks">
            <div class="session-tasks-title">Tasks Completed (${session.tasksCompleted.length})</div>
            ${session.tasksCompleted.map(t => `
              <div class="session-task-item">${t.text}</div>
            `).join('')}
          </div>
        `
        : '';

      const reflectionHtml = session.reflection
        ? `
          <div class="session-reflection">
            <div class="session-reflection-title">Reflection</div>
            <div class="session-rating">
              ${Array.from({ length: session.reflection.rating || 0 }, () => '<span class="star">‚òÖ</span>').join('')}
              ${Array.from({ length: 4 - (session.reflection.rating || 0) }, () => '<span class="star" style="opacity: 0.3;">‚òÖ</span>').join('')}
            </div>
            ${session.reflection.accomplishments ? `
              <div class="session-reflection-text" style="margin-top: 8px;">
                <strong>Accomplishments:</strong> ${session.reflection.accomplishments}
              </div>
            ` : ''}
            ${session.reflection.blockers ? `
              <div class="session-reflection-text" style="margin-top: 8px;">
                <strong>Blockers:</strong> ${session.reflection.blockers}
              </div>
            ` : ''}
          </div>
        `
        : '';

      const notesHtml = session.notes && session.notes.trim()
        ? `
          <div class="session-reflection">
            <div class="session-reflection-title">Notes</div>
            <div class="session-reflection-text">${session.notes}</div>
          </div>
        `
        : '';

      return `
        <div class="session-item">
          <div class="session-header">
            <div class="session-type">${session.type}</div>
            <div class="session-duration">${session.duration} min</div>
          </div>
          <div class="session-time">${dateStr} at ${timeStr}</div>
          ${tasksHtml}
          ${reflectionHtml}
          ${notesHtml}
        </div>
      `;
    }).join('');
  } */

  function format(ms) {
    const m = Math.floor(ms/60);
    const s = ms % 60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  function render() {
    timeEl.textContent = format(remaining);
    const ratio = 1 - (remaining / totalSecs);
    ring.setAttribute('stroke-dashoffset', String((1 - ratio) * dash));
  }
  function setLength(mins) {
    mins = Math.max(1, Math.min(180, Number(mins)||25));
    totalSecs = mins * 60;
    remaining = totalSecs;
    render();
    $('#customMins').value = mins;
    $$('.presets .chip').forEach(c => c.classList.toggle('active', c.dataset.mins == mins));
    pause();
    // Reset session when changing duration
    currentSession = null;
  }
  function start() {
    if (tickId) return;

    // Start session tracking
    if (!currentSession) {
      startSession();
    }

    const startAt = Date.now();
    let last = startAt;
    tickId = setInterval(() => {
      const now = Date.now();
      const delta = Math.floor((now - last)/1000);
      if (delta >= 1) {
        remaining = Math.max(0, remaining - delta);
        last = now;
        render();
        if (remaining <= 0) {
          pause();
          chime();
          completeSession();
          showToast('üéâ Focus session complete!', 'success');
        }
      }
    }, 250);
  }
  function pause() { clearInterval(tickId); tickId = null; }
  function reset() { remaining = totalSecs; render(); pause(); }
  function chime() {
    if (!$('#soundToggle').checked) return;
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = "sine"; o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.0);
      o.start(); o.stop(ctx.currentTime + 1.0);
    } catch {}
  }

  // ---------- Presets ----------
  $$('.presets .chip[data-mins]').forEach(btn => {
    btn.addEventListener('click', () => setLength(Number(btn.dataset.mins)));
  });
  $('#applyCustom').addEventListener('click', () => setLength($('#customMins').value));
  $('#startBtn').addEventListener('click', start);
  $('#pauseBtn').addEventListener('click', pause);
  $('#resetBtn').addEventListener('click', reset);

  // ---------- Tasks ----------
  // Migrate existing tasks to new format
  function migrateTasks() {
    const tasks = store.get('tasks', []);
    let migrated = false;

    const updatedTasks = tasks.map(task => {
      // Check if task needs migration (old format without id/timestamps)
      if (!task.id) {
        migrated = true;
        return {
          id: generateId(),
          text: task.text,
          done: task.done || false,
          createdAt: Date.now() - (7 * 24 * 60 * 60 * 1000), // Default to 7 days ago
          completedAt: task.done ? Date.now() - (1 * 24 * 60 * 60 * 1000) : null // If done, say completed yesterday
        };
      }
      return task;
    });

    if (migrated) {
      store.set('tasks', updatedTasks);
    }
  }

  // Generate unique ID
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
  }

  // Calculate analytics
  function calculateAnalytics() {
    const tasks = store.get('tasks', []);
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.done).length;
    const tasksCompletedToday = tasks.filter(t =>
      t.completedAt && t.completedAt >= todayStart
    ).length;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    return {
      total: totalTasks,
      completed: completedTasks,
      today: tasksCompletedToday,
      rate: completionRate
    };
  }

  // Render analytics
  function renderAnalytics() {
    const stats = calculateAnalytics();
    $('#statTotal').textContent = stats.total;
    $('#statCompleted').textContent = stats.completed;
    $('#statToday').textContent = stats.today;
    $('#statRate').textContent = stats.rate + '%';
  }

  function renderTasks() {
    const tasks = store.get('tasks', []);
    const list = $('#taskList');
    list.innerHTML = '';
    tasks.forEach((t, i) => {
      const row = document.createElement('div'); row.className = 'taskItem' + (t.done?' done':'');
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className='checkbox'; cb.checked = !!t.done;
      cb.addEventListener('change', () => {
        const wasCompleted = tasks[i].done;
        tasks[i].done = cb.checked;
        // Track completion timestamp
        if (cb.checked && !wasCompleted) {
          tasks[i].completedAt = Date.now();
        } else if (!cb.checked && wasCompleted) {
          tasks[i].completedAt = null;
        }
        store.set('tasks', tasks);
        renderTasks();
        renderAnalytics();
      });
      const label = document.createElement('div'); label.textContent = t.text;
      const del = document.createElement('button'); del.className='ghost small'; del.textContent='Delete';
      del.addEventListener('click', () => {
        tasks.splice(i,1);
        store.set('tasks', tasks);
        renderTasks();
        renderAnalytics();
      });
      row.append(cb, label, del);
      list.append(row);
    });
    renderAnalytics();
  }

  function addTaskFromInput() {
    const v = $('#taskInput').value.trim();
    if (!v) return;
    const tasks = store.get('tasks', []);
    // Create enhanced task with metadata
    const newTask = {
      id: generateId(),
      text: v,
      done: false,
      createdAt: Date.now(),
      completedAt: null
    };
    tasks.unshift(newTask);
    store.set('tasks', tasks);
    $('#taskInput').value = '';
    renderTasks();
    showToast('‚úì Task added', 'success');
  }
  $('#addTask').addEventListener('click', addTaskFromInput);
  $('#taskInput').addEventListener('keydown', e => { if (e.key === 'Enter') addTaskFromInput(); });
  $('#clearDone').addEventListener('click', () => {
    const before = store.get('tasks', []).length;
    const tasks = store.get('tasks', []).filter(t => !t.done);
    store.set('tasks', tasks);
    renderTasks();
    renderAnalytics();
    const removed = before - tasks.length;
    if (removed > 0) showToast(`üóëÔ∏è Cleared ${removed} completed task${removed > 1 ? 's' : ''}`, 'success');
  });
  $('#clearAll').addEventListener('click', () => {
    if (!confirm('Clear ALL tasks?')) return;
    const count = store.get('tasks', []).length;
    store.set('tasks', []);
    renderTasks();
    renderAnalytics();
    if (count > 0) showToast(`üóëÔ∏è Cleared ${count} task${count > 1 ? 's' : ''}`, 'success');
  });

  // ---------- Notes ----------
  const notes = $('#notes');
  notes.value = store.get('notes', '');
  notes.addEventListener('input', () => store.set('notes', notes.value));
  $('#downloadNotes').addEventListener('click', (e) => {
    e.preventDefault();
    if (!notes.value.trim()) {
      showToast('‚ö†Ô∏è No notes to download', 'danger');
      return;
    }
    const blob = new Blob([notes.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `focus-notes-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
    showToast('üì• Notes downloaded', 'success');
  });

  // ---------- Settings ----------
  const saved = store.get('settings', { mins: 25, sound: false });
  $('#soundToggle').checked = !!saved.sound;
  setLength(saved.mins || 25);


  // Migrate tasks on load
  migrateTasks();
  renderTasks();
  renderAnalytics();
  // renderSessionHistory(); // Removed - history tab disabled
  render();

  // Persist some state when leaving
  window.addEventListener('beforeunload', () => {
    store.set('settings', { mins: totalSecs/60, sound: $('#soundToggle').checked });
  });

})();
</script>
</body>
</html>

